# 팩터 투자 (Factor Investing) 가이드

## 이 프로젝트는 무엇인가?

### 목표

**"과거 데이터로 투자 전략을 검증하고, 어떤 전략이 효과가 있는지 확인한다."**

우리가 만든 것:
1. 한국 주식(KOSPI200) 데이터를 자동으로 수집하는 파이프라인
2. 학술적으로 검증된 투자 전략(팩터)을 구현한 코드
3. 과거 10년간 이 전략이 얼마나 수익을 냈는지 시뮬레이션하는 백테스터

### 왜 이게 필요한가?

투자 세계에는 수많은 "비법"이 있다:
- "이 차트 패턴이 나오면 산다"
- "PER 낮은 주식을 사면 된다"
- "외국인이 사는 종목을 따라 사라"

**문제**: 이 중 뭐가 진짜 작동하는지 어떻게 알까?

**해답**: 과거 데이터로 직접 테스트해본다.

```
"2015년부터 이 전략을 썼다면 어땠을까?"
→ 백테스트 결과: 연 15% 수익, 최대 낙폭 20%
→ "괜찮네, 더 연구해볼 가치가 있다"

또는

→ 백테스트 결과: 연 2% 수익, 코스피보다 못함
→ "이 전략은 쓸모없다"
```

### 왜 "팩터"인가?

아무 전략이나 테스트하는 게 아니다. 우리가 구현한 전략들은:

1. **학술 논문으로 검증됨**: 수십 년간 연구된 결과물
2. **글로벌 시장에서 작동**: 미국, 유럽, 아시아 모두에서 효과 확인
3. **경제학적 근거가 있음**: 왜 이게 작동하는지 설명 가능
4. **실제 펀드에서 사용**: 블랙록, 뱅가드 같은 대형 운용사가 실제로 운용

우리가 구현한 3가지 팩터:
- **모멘텀**: 오르던 주식은 계속 오른다
- **밸류**: 저평가된 주식이 결국 올라간다
- **퀄리티**: 돈 잘 버는 기업이 좋은 성과를 낸다

### 이걸 배우면 뭐가 좋은가?

**취업 준비생이라면**:
- 자소서에 "KOSPI200 팩터 백테스트 구현" 작성 가능
- 면접에서 "모멘텀 전략 Sharpe 0.88 달성" 구체적 숫자 제시
- 포트폴리오에 GitHub 링크 첨부

**투자에 관심 있다면**:
- "감"이 아닌 데이터 기반 의사결정
- 본인 투자 아이디어를 직접 검증 가능
- ETF/펀드 선택 시 팩터 이해하면 유리

**개발자라면**:
- 금융 데이터 파이프라인 구축 경험
- pandas, numpy 실전 활용
- API 연동, 캐싱, 백테스팅 시스템 설계

---

## 팩터 투자란?

**핵심 아이디어**: 주식 수익률을 설명하는 "공통 요인"이 있다.

전통적인 CAPM은 시장 베타 하나로 주식 수익률을 설명하려 했지만, 실제로는 설명되지 않는 부분이 많았다. 1990년대 Fama-French 교수가 발견한 것은:

> "시장 수익률 외에도, **기업 규모(Size)**와 **가치(Value)**가 주식 수익률을 체계적으로 설명한다"

이후 연구자들이 추가로 발견한 팩터들:
- **모멘텀**: 최근 오른 주식이 계속 오른다
- **퀄리티**: 수익성 좋은 기업이 좋은 성과를 낸다
- **저변동성**: 변동성 낮은 주식이 오히려 수익률이 높다

### 왜 팩터가 존재하는가?

두 가지 설명이 있다:

1. **위험 보상 (Risk-based)**: 가치주는 부도 위험이 높아서 프리미엄을 받는다
2. **행동재무학 (Behavioral)**: 투자자들이 체계적으로 실수를 한다 (과잉반응, 과소반응)

어느 쪽이든, 팩터 프리미엄은 수십 년간 지속되어 왔고, 이를 체계적으로 수확하는 것이 팩터 투자다.

---

## 우리가 구현한 3가지 팩터

### 1. 모멘텀 (Momentum) - "추세 추종"

**직관**: 오르던 주식은 계속 오르고, 떨어지던 주식은 계속 떨어진다.

**왜 작동하는가?**
- 좋은 뉴스가 나오면 투자자들이 천천히 반응한다 (under-reaction)
- 주가가 오르면 관심이 늘어나고, 더 많은 매수가 들어온다
- "승자를 쫓는" 인간 심리

**계산 방법: 12-1 모멘텀**

```
지난 12개월 수익률을 보되, 최근 1개월은 빼고 계산한다.

예: 2024년 6월 말 기준
  - 2023년 6월 ~ 2024년 5월 수익률 사용
  - 2024년 6월 수익률은 제외 (왜? 단기 반전 효과)
```

**왜 최근 1개월을 뺄까?**

단기적으로는 "반전 효과"가 있다. 이번 달 급등한 주식은 다음 달 조정받는 경향이 있다. 이걸 피하려고 최근 1개월을 제외한다.

```python
# 12-1 모멘텀 = 12개월 누적수익률 (최근 1개월 제외)
momentum = (1 + returns[-12:-1]).prod() - 1
```

**학술 근거**: Jegadeesh & Titman (1993) - "Returns to Buying Winners and Selling Losers"

---

### 2. 밸류 (Value) - "싸게 사기"

**직관**: 장부가치 대비 저평가된 주식이 장기적으로 수익률이 높다.

**왜 작동하는가?**
- 시장이 "지루한" 기업을 과소평가한다
- 문제 있는 기업도 있지만, 평균적으로 저평가 해소되며 수익 발생
- 반대로 "인기 있는" 성장주는 기대가 과도해 실망하는 경우가 많다

**계산 방법: Book-to-Market (B/M)**

```
B/M = 자기자본(장부가치) / 시가총액

- B/M 높음 → 가치주 (Value): 저평가, 인기 없음
- B/M 낮음 → 성장주 (Growth): 고평가, 인기 많음
```

**예시**:
- 삼성전자: 자기자본 300조, 시총 350조 → B/M = 0.86 (적정)
- 카카오: 자기자본 10조, 시총 20조 → B/M = 0.50 (성장주)
- 현대차: 자기자본 80조, 시총 50조 → B/M = 1.60 (가치주)

```python
B_M = total_equity / market_cap
```

**주의**: 재무제표 데이터는 공시 지연이 있다
- 12월 결산 기업 → 3월 말에 연간보고서 공시
- 따라서 4월부터 사용 가능 (3개월 lag 적용)

**학술 근거**: Fama-French (1992) - "The Cross-Section of Expected Stock Returns"

---

### 3. 퀄리티 (Quality) - "좋은 기업 사기"

**직관**: 수익성이 높은 기업이 좋은 성과를 낸다.

**왜 작동하는가?**
- 효율적으로 자본을 활용하는 기업은 경쟁 우위가 있다
- 높은 수익성은 지속되는 경향이 있다 (moat)
- 시장이 퀄리티의 지속성을 과소평가한다

**계산 방법: ROE (자기자본이익률)**

```
ROE = 순이익 / 자기자본

- ROE 높음 → 퀄리티 높음: 효율적인 기업
- ROE 낮음 → 퀄리티 낮음: 비효율적인 기업
```

**예시**:
- 순이익 10조, 자기자본 50조 → ROE = 20% (훌륭함)
- 순이익 1조, 자기자본 50조 → ROE = 2% (낮음)

```python
ROE = net_income / average_equity
```

**학술 근거**:
- Novy-Marx (2013) - "The Other Side of Value: The Gross Profitability Premium"
- Fama-French (2015) - 5-Factor Model에 퀄리티 추가

---

## 롱숏 전략이란?

### 기본 개념

**롱(Long)**: 주식을 산다 → 오르면 이익

**숏(Short)**: 주식을 빌려서 판다 → 떨어지면 이익
```
1. A 주식을 빌린다
2. 10,000원에 판다
3. 주가가 8,000원으로 떨어지면
4. 8,000원에 사서 갚는다
5. 차익 2,000원
```

### 롱숏 전략의 장점

**시장 중립 (Market Neutral)**:
- 롱 포지션: 시장이 오르면 이익
- 숏 포지션: 시장이 떨어지면 이익
- 합치면 시장 방향과 무관하게 **팩터 프리미엄만 수확**

```
예: 모멘텀 롱숏
- 롱: 모멘텀 높은 주식 40개 (동일 비중)
- 숏: 모멘텀 낮은 주식 40개 (동일 비중)

시장이 10% 하락해도:
- 롱 포지션: -8% (모멘텀 좋아서 시장보다 덜 빠짐)
- 숏 포지션: +12% (모멘텀 나빠서 시장보다 더 빠짐)
- 전체: +4% 수익!
```

---

## 퀸타일(Quintile) 분석

### 팩터가 정말 작동하는지 확인하는 방법

모든 주식을 팩터 점수로 정렬하고 5등분한다:

```
Q1 (하위 20%): 팩터 점수 가장 낮음
Q2 (20-40%)
Q3 (40-60%)
Q4 (60-80%)
Q5 (상위 20%): 팩터 점수 가장 높음
```

**팩터가 유효하다면**:
- Q5 수익률 > Q4 > Q3 > Q2 > Q1
- 단조 증가(monotonic)해야 함

**우리 테스트 결과 (모멘텀)**:
```
Q1: +9.7%   ← 모멘텀 낮은 주식
Q2: +6.0%
Q3: +26.7%
Q4: +27.4%
Q5: +55.8%  ← 모멘텀 높은 주식

→ Q5가 Q1보다 46%p 높다! 팩터 유효!
```

---

## 백테스팅이란?

### 정의

**과거 데이터로 전략을 시뮬레이션**하는 것.

"2015년부터 이 전략을 썼다면 얼마를 벌었을까?"

### 우리의 백테스트 설정

| 항목 | 설정 |
|------|------|
| 유니버스 | KOSPI200 (대형주 200개) |
| 기간 | 2015-2024 (10년) |
| 리밸런싱 | 월 1회 (매월 말) |
| 거래비용 | 10bp (0.1%) |
| 포트폴리오 | 퀸타일 롱숏 |

### 주의: Look-ahead Bias (미래 정보 사용 오류)

백테스트에서 가장 흔한 실수:

❌ **잘못된 예**:
- 12월 31일 결산 재무제표를 1월 1일에 사용
- 실제로는 3월 말에야 공시됨!

✅ **올바른 방법**:
- 재무제표는 공시 후 3개월 lag 적용
- 팩터 계산 시 "그 시점에 알 수 있던 정보만" 사용

---

## 성과 지표 해석

### 1. CAGR (연평균 복리 수익률)

```
CAGR = (최종가치/초기가치)^(1/년수) - 1

예: 100만원 → 5년 후 200만원
CAGR = (200/100)^(1/5) - 1 = 14.9%
```

**해석**: 매년 평균 14.9%씩 복리로 성장

### 2. Sharpe Ratio (샤프 비율)

```
Sharpe = (수익률 - 무위험이자율) / 변동성

예: 연 15% 수익, 무위험 3%, 변동성 20%
Sharpe = (15% - 3%) / 20% = 0.6
```

**해석**:
- **1.0 이상**: 매우 좋음 (헤지펀드 목표)
- **0.5-1.0**: 괜찮음
- **0.5 이하**: 개선 필요

**의미**: 위험 1단위당 얼마의 초과수익을 얻는가

### 3. MDD (Maximum Drawdown, 최대 낙폭)

```
MDD = (고점 - 저점) / 고점

예: 100 → 150 → 90 → 120
MDD = (150 - 90) / 150 = 40%
```

**해석**: 최악의 경우 얼마나 잃을 수 있는가

**중요한 이유**:
- MDD 40%면 복구하려면 67% 상승 필요
- MDD 50%면 복구하려면 100% 상승 필요

### 4. Turnover (회전율)

```
Turnover = 매수금액 / 포트폴리오 가치

예: 1억 포트폴리오에서 월 4천만 매매
월간 Turnover = 40%
연간 Turnover = 480%
```

**해석**: 높은 회전율 = 높은 거래비용

---

## 실행 가이드

### 1단계: 데이터 준비

```python
from src.data.kospi200 import get_kospi200_tickers
from src.data.price import fetch_price_data

# KOSPI200 종목 가져오기
tickers = get_kospi200_tickers('20240101')

# 10년치 가격 데이터
prices = fetch_price_data(tickers, '2015-01-01', '2024-12-01')
```

### 2단계: 팩터 정의

```python
from src.data.price import calculate_returns
from src.factors.momentum import calculate_momentum_12_1

def my_factor(prices, date):
    """12-1 모멘텀 팩터"""
    monthly_returns = calculate_returns(prices, period='monthly')
    return calculate_momentum_12_1(monthly_returns, date)
```

### 3단계: 백테스트 실행

```python
from src.portfolio.backtest import run_backtest

results = run_backtest(
    prices=prices,
    factor_func=my_factor,
    start_date='2016-01-01',
    end_date='2024-11-30',
    rebalance_freq='monthly',      # 월간 리밸런싱
    transaction_cost_bps=10        # 거래비용 10bp
)
```

### 4단계: 결과 분석

```python
from src.portfolio.backtest import analyze_backtest_results

summary = analyze_backtest_results(results)
print(summary)

# 출력 예시:
# Total Return: 47.82%
# CAGR: 25.02%
# Sharpe Ratio: 0.88
# Max Drawdown: -14.38%
```

### 5단계: 시각화

```python
from src.analytics.visualization import plot_cumulative_returns

fig = plot_cumulative_returns({'Momentum L/S': results['returns']})
fig.savefig('backtest_result.png')
```

---

## 한국 시장 특수성

### 1. 공매도 제한

한국은 개인 공매도가 제한되어 있다. 따라서:
- 백테스트는 "이론적" 롱숏 수익률
- 실제 구현 시 롱온리 전략 고려 필요

### 2. KOSPI200 정기변경

매년 6월에 구성종목이 바뀐다.
- **생존편향(Survivorship Bias)** 주의
- 상장폐지된 종목도 백테스트에 포함해야 정확

### 3. 재무제표 공시 일정

| 보고서 | 기준일 | 공시 기한 |
|--------|--------|----------|
| 연간보고서 | 12/31 | 다음해 3/31 |
| 반기보고서 | 6/30 | 8/15 |
| 분기보고서 | 3/31, 9/30 | 45일 이내 |

---

## 자주 묻는 질문

### Q: 백테스트 수익률을 실제로 얻을 수 있나요?

**A**: 보통 실제 수익률은 백테스트보다 낮다.

이유:
1. **거래비용**: 실제로는 더 높을 수 있음
2. **슬리피지**: 원하는 가격에 못 살 수 있음
3. **시장 충격**: 대량 매매 시 가격 변동
4. **구현 오차**: 리밸런싱 타이밍 차이

### Q: 어떤 팩터가 가장 좋나요?

**A**: 시기마다 다르다.

- 2020-2021: 모멘텀이 좋았음 (성장주 장세)
- 2022: 밸류가 좋았음 (금리 인상기)

**해결책**: 여러 팩터를 조합하면 안정적

### Q: 얼마나 자주 리밸런싱해야 하나요?

**A**: 월간이 일반적.

- 너무 자주: 거래비용 증가
- 너무 드물게: 팩터 효과 약화

---

## 참고 문헌

1. **Fama & French (1992)** - "The Cross-Section of Expected Stock Returns"
   - 시장, 규모, 가치 3팩터 모델의 시초

2. **Jegadeesh & Titman (1993)** - "Returns to Buying Winners and Selling Losers"
   - 모멘텀 효과의 발견

3. **Novy-Marx (2013)** - "The Other Side of Value"
   - 퀄리티(수익성) 팩터

4. **Fama & French (2015)** - "A Five-Factor Asset Pricing Model"
   - 투자, 수익성 팩터 추가

---

## DART API 키 설정

재무제표 데이터를 사용하려면 DART API 키가 필요하다.

**1. API 키 신청**: https://opendart.fss.or.kr/
   - 회원가입 후 인증키 신청 (무료, 즉시 발급)

**2. 프로젝트에 설정**:
```bash
# .env 파일 생성 (프로젝트 루트)
DART_API_KEY=your_api_key_here
```

---

## 핵심 수식 정리

팩터 투자에서 알아야 할 수식들.

### 1. 수익률 계산

**단순 수익률 (Simple Return)**
```
R_t = (P_t - P_{t-1}) / P_{t-1} = P_t / P_{t-1} - 1
```
- P_t: t시점 가격
- 예: 100원 → 110원 → R = (110-100)/100 = 10%

**로그 수익률 (Log Return)**
```
r_t = ln(P_t / P_{t-1}) = ln(P_t) - ln(P_{t-1})
```
- 왜 쓰나? 시간 가산성: r_1 + r_2 = r_{1→2} (단순 수익률은 안됨)
- 예: ln(110/100) = 9.53%

**누적 수익률 (Cumulative Return)**
```
R_{1→n} = (1 + R_1)(1 + R_2)...(1 + R_n) - 1
        = ∏(1 + R_t) - 1
```
- 예: 월 수익률 5%, 5%, -3% → (1.05)(1.05)(0.97) - 1 = 6.9%

### 2. 팩터 수식

**모멘텀 (12-1)**
```
MOM_i = ∏_{t=-12}^{-2} (1 + R_{i,t}) - 1
```
- i: 종목
- t: 월 (-12는 12개월 전, -2는 2개월 전)
- 최근 1개월(-1) 제외하는 이유: 단기 반전 효과

**Book-to-Market (밸류)**
```
B/M_i = BE_i / ME_i
```
- BE: Book Equity (자기자본, 재무제표)
- ME: Market Equity (시가총액 = 주가 × 발행주식수)

**ROE (퀄리티)**
```
ROE = NI / ((E_t + E_{t-1}) / 2)
```
- NI: Net Income (순이익)
- E: Equity (자기자본)
- 평균 자기자본 쓰는 이유: 기간 중 변동 반영

### 3. 포트폴리오 수식

**포트폴리오 수익률**
```
R_p = Σ w_i × R_i
```
- w_i: i번째 종목 비중 (Σw_i = 1)
- R_i: i번째 종목 수익률

**롱숏 포트폴리오 수익률**
```
R_{LS} = R_{Long} - R_{Short}
       = Σ w_i^L × R_i - Σ w_j^S × R_j
```
- 롱/숏 각각 비중 합이 1

**포트폴리오 분산**
```
σ²_p = Σ Σ w_i w_j σ_{ij}
     = Σ Σ w_i w_j ρ_{ij} σ_i σ_j
```
- σ_{ij}: 공분산
- ρ_{ij}: 상관계수
- 분산효과: n개 종목 동일 비중, 상관관계 0이면 → σ²_p = σ²/n

### 4. 성과 지표 수식

**Sharpe Ratio**
```
SR = (E[R_p] - R_f) / σ_p
```
- E[R_p]: 포트폴리오 기대수익률
- R_f: 무위험이자율
- σ_p: 포트폴리오 표준편차

**연율화 (Annualization)**
```
연율화 수익률 = 월간 수익률 × 12
연율화 변동성 = 월간 변동성 × √12
연율화 Sharpe = 월간 Sharpe × √12
```
- √12 ≈ 3.46

**CAGR (복리 연평균 성장률)**
```
CAGR = (V_n / V_0)^{1/n} - 1
```
- V_0: 초기 가치
- V_n: n년 후 가치
- n: 연수

**Maximum Drawdown**
```
MDD = min_t [ (NAV_t - max_{s≤t} NAV_s) / max_{s≤t} NAV_s ]
```
- 고점 대비 최대 하락폭
- 항상 음수 또는 0

**Information Ratio**
```
IR = E[R_p - R_b] / σ(R_p - R_b)
   = α / TE
```
- R_b: 벤치마크 수익률
- α (알파): 초과수익률
- TE (Tracking Error): 초과수익률의 표준편차

### 5. 회귀분석 (Fama-French)

**CAPM**
```
E[R_i] - R_f = β_i (E[R_m] - R_f)
```
- β: 시장 민감도
- R_m: 시장 수익률

**Fama-French 3-Factor Model**
```
R_i - R_f = α + β_mkt(R_m - R_f) + β_smb×SMB + β_hml×HML + ε
```
- SMB (Small Minus Big): 소형주 - 대형주 수익률
- HML (High Minus Low): 가치주 - 성장주 수익률
- α: 팩터로 설명 안 되는 초과수익 (양수면 좋음)

**5-Factor Model (2015)**
```
R_i - R_f = α + β_mkt×MKT + β_smb×SMB + β_hml×HML
          + β_rmw×RMW + β_cma×CMA + ε
```
- RMW (Robust Minus Weak): 수익성 팩터
- CMA (Conservative Minus Aggressive): 투자 팩터

### 6. 개념 점검 Q&A

**Q: Sharpe Ratio 1.0이면 어떤 의미인가?**

위험(변동성) 1단위당 초과수익 1단위를 얻는다는 의미. 연 변동성 20%일 때, 무위험 대비 20% 초과수익을 낸다는 뜻이다.

**Q: 왜 로그 수익률을 쓰나?**

시간 가산성 때문. `r_1 + r_2 = r_{1→2}`. 단순 수익률은 곱해야 해서 계산이 불편하고, 로그 수익률이 정규분포 가정에 더 적합하다.

**Q: MDD -30%면 원금 회복하려면?**

100 → 70이면 다시 100이 되려면 `(100-70)/70 = 42.9%` 상승 필요. 일반화하면: `회복률 = -MDD / (1 + MDD)`

**Q: 팩터 수익률이 양수라는 건?**

해당 특성을 가진 주식이 체계적으로 시장을 이겼다는 것. 예: HML > 0이면 가치주가 성장주보다 좋았다.

**Q: 알파(α)란?**

팩터 노출로 설명되지 않는 초과수익. 양수면 팩터 대비 추가 수익을 냈다는 의미.

---

## 파일 구조

```
src/
├── data/               # 데이터 수집
│   ├── kospi200.py     # KOSPI200 종목 목록
│   ├── price.py        # 주가 데이터
│   ├── fundamental.py  # 재무제표 (DART)
│   └── cache.py        # 캐싱 (API 호출 절약)
│
├── factors/            # 팩터 계산
│   ├── momentum.py     # 모멘텀 (12-1)
│   ├── value.py        # 밸류 (B/M)
│   ├── quality.py      # 퀄리티 (ROE)
│   └── composite.py    # 복합 팩터
│
├── portfolio/          # 포트폴리오 & 백테스트
│   ├── construction.py # 롱숏 포트폴리오 구성
│   ├── backtest.py     # 백테스팅 엔진
│   ├── transaction.py  # 거래비용 계산
│   └── rebalance.py    # 리밸런싱 일정
│
└── analytics/          # 분석 & 시각화
    ├── metrics.py      # Sharpe, MDD 등
    └── visualization.py # 차트
```
